{% extends "base.html" %}

{% block title %}My Watchlist - OTT Radar{% endblock %}

{% block content %}
<div class="container" style="padding: 3rem 0;">
    <div class="mobile-only">
        <section class="mobile-page-header">
            <h1 class="mobile-page-title">Watchlist</h1>
            <p class="mobile-page-subtitle">Your saved movies</p>
        </section>
    </div>
    <div class="desktop-only" style="margin-bottom: 3rem;">
        <h1 style="font-size: 2.5rem; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-bookmark" style="color: var(--accent-primary); font-size: 2rem;"></i>
            My Watchlist
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem; margin: 0;">
            Keep track of movies you want to watch and where to find them
        </p>
    </div>

    <!-- Watchlist Recovery CTA -->
    <div style="margin-bottom: 2rem; padding: 1.25rem 1.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; display: flex; flex-wrap: wrap; align-items: center; gap: 1rem;">
        <div style="flex: 1; min-width: 220px;">
            <h3 style="margin: 0 0 0.25rem 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-shield-alt" style="color: var(--accent-primary);"></i>
                Save My Watchlist
            </h3>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem;">Link your email to protect your watchlist if cookies are cleared.</p>
        </div>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
            <input id="watchlist-email" type="email" placeholder="you@example.com" style="padding: 0.65rem 0.9rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-primary); min-width: 220px;">
            <button type="button" onclick="linkWatchlistEmail()" style="padding: 0.65rem 1.1rem; background: var(--accent-primary); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                <i class="fas fa-paper-plane"></i> Send Link
            </button>
        </div>
        <div id="watchlist-link-status" style="width: 100%; font-size: 0.9rem; color: var(--text-secondary);"></div>
    </div>

    <!-- Status Filter Tabs -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <a href="{{ url_for('watchlist', status='') }}" style="padding: 0.75rem 1.5rem; background: {% if not status or status == '' %}var(--accent-primary){% else %}var(--bg-card){% endif %}; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; border: 1px solid {% if not status or status == '' %}var(--accent-primary){% else %}var(--text-secondary){% endif %}; transition: all 0.3s;">
            All ({{ total }})
        </a>
        <a href="{{ url_for('watchlist', status='watchlist') }}" style="padding: 0.75rem 1.5rem; background: {% if status == 'watchlist' %}var(--accent-primary){% else %}var(--bg-card){% endif %}; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; border: 1px solid {% if status == 'watchlist' %}var(--accent-primary){% else %}var(--text-secondary){% endif %}; transition: all 0.3s;">
            Want to Watch ({{ counts.watchlist }})
        </a>
        <a href="{{ url_for('watchlist', status='watched') }}" style="padding: 0.75rem 1.5rem; background: {% if status == 'watched' %}var(--accent-primary){% else %}var(--bg-card){% endif %}; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; border: 1px solid {% if status == 'watched' %}var(--accent-primary){% else %}var(--text-secondary){% endif %}; transition: all 0.3s;">
            Watched ({{ counts.watched }})
        </a>
        <a href="{{ url_for('watchlist', status='interested') }}" style="padding: 0.75rem 1.5rem; background: {% if status == 'interested' %}var(--accent-primary){% else %}var(--bg-card){% endif %}; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; border: 1px solid {% if status == 'interested' %}var(--accent-primary){% else %}var(--text-secondary){% endif %}; transition: all 0.3s;">
            Interested ({{ counts.interested }})
        </a>
    </div>

    {% if movies %}
    <!-- Movies List -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
        {% for item in movies %}
        <div style="position: relative; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'">
            <a href="{{ url_for('movie_detail', movie_identifier=item.movie.title|movie_slug) }}" style="text-decoration: none; color: inherit; display: block;">
                <div style="position: relative; padding-bottom: 150%; overflow: hidden; border-radius: var(--radius-md); box-shadow: 0 8px 16px rgba(0,0,0,0.4); transition: all 0.3s ease;">
                    {% if item.movie.poster %}
                    <img src="{{ item.movie.poster }}" alt="{{ item.movie.title }}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--bg-card), rgba(255,255,255,0.1)); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-image" style="font-size: 2rem; color: var(--text-secondary);"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Status Badge -->
                    <div style="position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.4rem 0.8rem; background: {% if item.status == 'watched' %}rgba(76, 175, 80, 0.9){% elif item.status == 'interested' %}rgba(255, 152, 0, 0.9){% else %}rgba(33, 150, 243, 0.9){% endif %}; border-radius: 6px; font-weight: 700; font-size: 0.75rem; color: white;">
                        {% if item.status == 'watched' %}✓ WATCHED{% elif item.status == 'interested' %}♡ INTERESTED{% else %}→ WATCH{% endif %}
                    </div>
                    
                    <!-- Where to Watch -->
                    {% if item.platforms_available %}
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 0.75rem; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.9)); display: flex; gap: 0.4rem; flex-wrap: wrap;">
                        {% for platform in item.platforms_available[:2] %}
                        <span style="font-size: 0.7rem; background: var(--accent-primary); color: white; padding: 0.3rem 0.6rem; border-radius: 4px; white-space: nowrap;">{{ platform }}</span>
                        {% endfor %}
                        {% if item.platforms_available|length > 2 %}
                        <span style="font-size: 0.7rem; background: rgba(255,255,255,0.2); color: white; padding: 0.3rem 0.6rem; border-radius: 4px;">+{{ item.platforms_available|length - 2 }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </a>
            
            <div style="margin-top: 0.75rem;">
                <p style="margin: 0; font-weight: 600; font-size: 0.95rem; color: var(--text-primary); line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ item.movie.title }}</p>
                {% if item.movie.rating %}
                <p style="margin: 0.3rem 0 0 0; font-size: 0.8rem; color: var(--text-secondary);">
                    <i class="fas fa-star" style="color: #ffc107; margin-right: 0.3rem;"></i>{{ "%.1f"|format(item.movie.rating) }}
                </p>
                {% endif %}
                <p style="margin: 0.3rem 0 0 0; font-size: 0.75rem; color: var(--text-secondary);">
                    Added {{ item.added_at.strftime('%Y-%m-%d') }}
                </p>
            </div>
            
            <!-- Action Buttons -->
            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                <form method="POST" style="flex: 1;">
                    <input type="hidden" name="movie_id" value="{{ item.movie_id }}">
                    <input type="hidden" name="tmdb_id" value="{{ item.movie.tmdb_id }}">
                    {% if item.status != 'watched' %}
                    <input type="hidden" name="action" value="watched">
                    <button type="submit" style="width: 100%; padding: 0.5rem 0.75rem; background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--text-secondary); border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'; this.style.color='#4caf50';" onmouseout="this.style.background='var(--bg-card)'; this.style.color='var(--text-secondary)';">✓ Mark Watched</button>
                    {% else %}
                    <input type="hidden" name="action" value="watchlist">
                    <button type="submit" style="width: 100%; padding: 0.5rem 0.75rem; background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--text-secondary); border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 152, 0, 0.3)'; this.style.color='#ff9800';" onmouseout="this.style.background='var(--bg-card)'; this.style.color='var(--text-secondary)';">↶ Unwatch</button>
                    {% endif %}
                </form>
                <form method="POST" style="flex: 1;">
                    <input type="hidden" name="movie_id" value="{{ item.movie_id }}">
                    <input type="hidden" name="tmdb_id" value="{{ item.movie.tmdb_id }}">
                    <input type="hidden" name="action" value="remove">
                    <button type="submit" style="width: 100%; padding: 0.5rem 0.75rem; background: var(--bg-card); color: '#ff6b6b'; border: 1px solid '#ff6b6b'; border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s;" onclick="return confirm('Remove from watchlist?');" onmouseover="this.style.background='rgba(255, 107, 107, 0.3)'; this.style.borderColor='#ff6b6b';" onmouseout="this.style.background='var(--bg-card)'; this.style.borderColor='#ff6b6b';">✕ Remove</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Empty Watchlist -->
    <div style="text-align: center; padding: 4rem 2rem; background: var(--bg-card); border-radius: var(--radius-md); border: 2px dashed var(--border-color);">
        <i class="fas fa-bookmark" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; display: block;"></i>
        <h2 style="color: var(--text-secondary); margin: 0 0 0.5rem 0;">Your watchlist is empty</h2>
        <p style="color: var(--text-muted); margin: 0 0 2rem 0;">Start adding movies to keep track of what you want to watch</p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="{{ url_for('filter_movies') }}" style="padding: 0.75rem 1.5rem; background: var(--accent-primary); color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">Browse Movies</a>
            <a href="{{ url_for('filter_movies') }}" style="padding: 0.75rem 1.5rem; background: var(--bg-card); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; border: 1px solid var(--border-color);">YouTube Movies</a>
            <a href="{{ url_for('trending') }}" style="padding: 0.75rem 1.5rem; background: var(--bg-card); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; border: 1px solid var(--border-color);">Trending</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
function linkWatchlistEmail() {
    const emailInput = document.getElementById('watchlist-email');
    const statusEl = document.getElementById('watchlist-link-status');
    const email = emailInput ? emailInput.value.trim() : '';

    if (!email) {
        statusEl.textContent = 'Please enter a valid email address.';
        statusEl.style.color = '#e50914';
        return;
    }

    statusEl.textContent = 'Sending verification link...';
    statusEl.style.color = 'var(--text-secondary)';

    fetch('/watchlist/link-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            statusEl.textContent = `Verification link sent to ${data.email}. Check your inbox.`;
            statusEl.style.color = '#4caf50';
        } else {
            statusEl.textContent = data.error || 'Unable to link email.';
            statusEl.style.color = '#e50914';
        }
    })
    .catch(err => {
        statusEl.textContent = `Request failed: ${err.message}`;
        statusEl.style.color = '#e50914';
    });
}
</script>
{% endblock %}
